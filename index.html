<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ระบบจัดการภาพสำหรับครู</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

  <style>
    body { font-family: 'Prompt', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    .upload-zone { border: 2px dashed #cbd5e0; transition: all 0.3s ease; }
    .upload-zone.dragover { border-color: #4299e1; background-color: #ebf8ff; }
    .progress-bar { transition: width 0.3s ease; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-lg border-b-4 border-blue-500 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center space-x-4">
          <div class="flex items-center space-x-3">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-xl shadow-lg">
              <i class="fas fa-images text-white text-2xl"></i>
            </div>
            <div>
              <h1 class="text-xl md:text-2xl font-bold text-gray-800">ระบบจัดการภาพ</h1>
              <p class="text-sm text-gray-600">สำหรับครู</p>
            </div>
          </div>
        </div>
        <div class="hidden sm:flex items-center space-x-2 bg-green-100 px-3 py-2 rounded-full">
          <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
          <span class="text-green-700 text-sm font-medium">ออนไลน์</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="min-h-screen">
    <div class="p-4 md:p-8">
      <!-- Welcome -->
      <div class="mb-8">
        <div class="gradient-bg rounded-2xl p-6 md:p-8 text-white">
          <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="mb-4 md:mb-0">
              <h2 class="text-2xl md:text-3xl font-bold mb-2">ยินดีต้อนรับสู่ระบบจัดการภาพ</h2>
              <p class="text-blue-100">จัดเก็บและจัดการภาพและวีดีโอของคุณอย่างมีประสิทธิภาพ</p>
            </div>
            <div class="text-center">
              <div class="text-3xl md:text-4xl font-bold" id="totalFiles">0</div>
              <div class="text-blue-100">ไฟล์ทั้งหมด</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Actions -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-6 md:p-8 text-white card-hover cursor-pointer" onclick="showCreateFolderModal()">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl md:text-2xl font-bold mb-2">สร้างโฟลเดอร์</h3>
              <p class="text-green-100 mb-4">สร้างโฟลเดอร์ใหม่สำหรับจัดเก็บภาพและวีดีโอ</p>
              <div class="inline-flex items-center space-x-2 bg-white bg-opacity-20 px-4 py-2 rounded-full">
                <i class="fas fa-plus"></i>
                <span class="font-medium">เริ่มสร้าง</span>
              </div>
            </div>
            <div class="text-4xl md:text-6xl opacity-20">
              <i class="fas fa-folder-plus"></i>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl p-6 md:p-8 text-white card-hover cursor-pointer" onclick="openFolderPicker()">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-xl md:text-2xl font-bold mb-2">อัพโหลดภาพ</h3>
              <p class="text-purple-100 mb-4">เลือกโฟลเดอร์และอัพโหลดภาพหรือวีดีโอ</p>
              <div class="inline-flex items-center space-x-2 bg-white bg-opacity-20 px-4 py-2 rounded-full">
                <i class="fas fa-upload"></i>
                <span class="font-medium">เลือกโฟลเดอร์</span>
              </div>
            </div>
            <div class="text-4xl md:text-6xl opacity-20">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-lg border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">โฟลเดอร์</p>
              <p class="text-2xl font-bold text-blue-600" id="totalFolders">0</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg">
              <i class="fas fa-folder text-blue-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-lg border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">ภาพ</p>
              <p class="text-2xl font-bold text-green-600" id="totalImages">0</p>
            </div>
            <div class="bg-green-100 p-3 rounded-lg">
              <i class="fas fa-image text-green-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-lg border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">วีดีโอ</p>
              <p class="text-2xl font-bold text-purple-600" id="totalVideos">0</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-lg">
              <i class="fas fa-video text-purple-600"></i>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl p-4 md:p-6 shadow-lg border border-gray-100">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">กำลังอัพโหลด</p>
              <p class="text-2xl font-bold text-orange-600" id="uploadingFiles">0</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-lg">
              <i class="fas fa-spinner text-orange-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="bg-white rounded-2xl shadow-lg border border-gray-100 p-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-clock text-blue-600 mr-3"></i>
          กิจกรรมล่าสุด
        </h3>
        <div id="recentActivity" class="space-y-3">
          <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
            <div class="W-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-info text-blue-600"></i>
            </div>
            <div>
              <p class="text-gray-800">ยินดีต้อนรับสู่ระบบจัดการภาพ</p>
              <p class="text-sm text-gray-600">เริ่มต้นใช้งานโดยสร้างโฟลเดอร์หรืออัพโหลดภาพ</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="px-4 md:px-8">
      <p class="text-center text-gray-600 text-sm">พัฒนาโดย นายจิรายุทธ แสงสิน</p>
    </div>
  </footer>

  <!-- Create Folder Modal -->
  <div id="createFolderModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-green-100 rounded-full mx-auto mb-4 flex items-center justify-center">
          <i class="fas fa-folder-plus text-green-600 text-2xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-800">สร้างโฟลเดอร์ใหม่</h3>
        <p class="text-gray-600 mt-2">กรุณาตั้งชื่อโฟลเดอร์ที่ต้องการสร้าง</p>
      </div>
      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อโฟลเดอร์</label>
        <input type="text" id="folderNameInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="เช่น ภาพกิจกรรมวันที่ 1">
      </div>
      <div class="flex space-x-3">
        <button onclick="hideCreateFolderModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">ยกเลิก</button>
        <button onclick="createFolder()" class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">สร้างโฟลเดอร์</button>
      </div>
    </div>
  </div>

  <!-- Folder List Modal -->
  <div id="folderListModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-gray-800">เลือกโฟลเดอร์</h3>
            <p class="text-gray-600 mt-1">เลือกโฟลเดอร์ที่ต้องการอัพโหลดภาพ</p>
          </div>
          <button onclick="hideFolderList()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      <div class="p-6 overflow-y-auto max-h-96">
        <div id="folderListContent" class="space-y-3"></div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
      <!-- ========== HEADER (moved controls to top-right) ========== -->
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-xl font-bold text-gray-800">อัพโหลดภาพและวีดีโอ</h3>
            <p class="text-gray-600 mt-1">โฟลเดอร์: <span id="currentFolderName" class="font-medium text-blue-600"></span></p>
          </div>

          <!-- NEW: header controls -->
          <div class="flex items-center space-x-3">
            <div id="uploadHeaderControls" class="hidden flex items-center space-x-3">
              <span class="text-sm text-gray-600">
                <span id="uploadProgress">0</span> / <span id="uploadTotal">0</span> ไฟล์
              </span>
              <button id="startUploadBtn" onclick="startUpload()"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-play mr-2"></i>เริ่มอัพโหลด
              </button>
            </div>
            <button onclick="hideUploadModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>
      </div>
      <!-- ========================================================= -->

      <div class="p-6">
        <!-- Upload Zone -->
        <div id="uploadZone" class="upload-zone rounded-xl p-8 text-center mb-6 cursor-pointer" onclick="document.getElementById('fileInput').click()">
          <div class="mb-4">
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
          </div>
          <h4 class="text-lg font-semibold text-gray-700 mb-2">ลากไฟล์มาวางที่นี่ หรือคลิกเพื่อเลือกไฟล์</h4>
          <p class="text-gray-500">รองรับไฟล์ภาพ (JPG, PNG, GIF, WEBP) และวีดีโอ (MP4, MOV, AVI, WMV, FLV) ขนาดไม่เกิน 50MB</p>
          <input type="file" id="fileInput" multiple accept="image/*,video/*" class="hidden">
        </div>

        <!-- Upload Queue -->
        <div id="uploadQueue" class="hidden">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">คิวการอัพโหลด</h4>
          <div id="uploadList" class="space-y-3 max-h-60 overflow-y-auto"></div>

          <!-- (REMOVED) footer controls moved to header -->
          <!-- previously had progress + start button here -->
        </div>
      </div>
    </div>
  </div>

  <!-- ======== APP SCRIPT INTEGRATION ======== -->
  <script>
    // ===== CONFIG =====
    const SCRIPT_URL = 'PUT_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE'; // <- ใส่ URL จาก Deploy
    const CLIENT_ALLOWED_TYPES = [
      'image/jpeg','image/jpg','image/png','image/gif','image/webp',
      'video/mp4','video/mov','video/avi','video/wmv','video/flv'
    ];
    const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB

    // ===== STATE =====
    let currentFolder = null;
    let uploadQueue = [];
    let isUploading = false;
    let folders = [];

    // ===== UTIL: API WRAPPER (หลบ CORS preflight ด้วย text/plain) =====
    async function apiGet(action, params = {}) {
      const q = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(`${SCRIPT_URL}?${q}`, { method: 'GET' });
      const text = await res.text();
      return JSON.parse(text);
    }
    async function apiPost(payload) {
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=UTF-8' },
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      return JSON.parse(txt);
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', function () {
      initializeApp();
      setupEventListeners();
      refreshAll(); // โหลดโฟลเดอร์ + สถิติ
    });

    async function refreshAll() {
      await Promise.all([loadFolders(), loadStats()]);
    }

    function initializeApp() {
      const uploadZone = document.getElementById('uploadZone');
      uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
      uploadZone.addEventListener('dragleave', (e) => { e.preventDefault(); uploadZone.classList.remove('dragover'); });
      uploadZone.addEventListener('drop', (e) => {
        e.preventDefault(); uploadZone.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleFileSelection(files);
      });
      document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFileSelection(files);
      });
    }

    function setupEventListeners() {
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') { hideCreateFolderModal(); hideFolderList(); hideUploadModal(); }
        if (e.key === 'Enter' && document.getElementById('folderNameInput') === document.activeElement) { createFolder(); }
      });
    }

    // ====== Modals ======
    function showCreateFolderModal(){ document.getElementById('createFolderModal').classList.remove('hidden'); document.getElementById('folderNameInput').focus();}
    function hideCreateFolderModal(){ document.getElementById('createFolderModal').classList.add('hidden'); document.getElementById('folderNameInput').value='';}
    function openFolderPicker(){ document.getElementById('folderListModal').classList.remove('hidden'); displayFolders(); }
    function hideFolderList(){ document.getElementById('folderListModal').classList.add('hidden'); }
    function showUploadModal(folder){ currentFolder = folder; document.getElementById('currentFolderName').textContent = folder.name; document.getElementById('uploadModal').classList.remove('hidden'); }
    function hideUploadModal(){
      document.getElementById('uploadModal').classList.add('hidden');
      currentFolder=null;
      uploadQueue=[];
      document.getElementById('uploadQueue').classList.add('hidden');
      document.getElementById('fileInput').value='';

      // NEW: reset header controls
      const headerCtrls = document.getElementById('uploadHeaderControls');
      if (headerCtrls) headerCtrls.classList.add('hidden');
      const up = document.getElementById('uploadProgress');
      const ut = document.getElementById('uploadTotal');
      if (up) up.textContent = '0';
      if (ut) ut.textContent = '0';
    }

    // ====== FOLDERS ======
    async function createFolder() {
      const folderName = document.getElementById('folderNameInput').value.trim();
      if (!folderName) {
        Swal.fire({icon:'warning',title:'กรุณาใส่ชื่อโฟลเดอร์',text:'ชื่อโฟลเดอร์ห้ามเว้นว่าง'}); return;
      }
      try {
        Swal.fire({ title:'กำลังสร้างโฟลเดอร์...', allowOutsideClick:false, didOpen:()=>Swal.showLoading()});
        const resp = await apiPost({ action:'createFolder', folderName, teacherName:'ครูผู้สอน' });
        if (!resp.success) throw new Error(resp.message || 'สร้างโฟลเดอร์ไม่สำเร็จ');
        hideCreateFolderModal();
        await loadFolders(); // refresh list
        Swal.fire({ icon:'success', title:'สร้างโฟลเดอร์สำเร็จ', text:`"${folderName}" ถูกสร้างแล้ว`})
          .then(()=> { const f = folders.find(x=>x.id===resp?.data?.id) || resp.data; if (f) showUploadModal(f); });
        addRecentActivity('สร้างโฟลเดอร์', `สร้าง "${folderName}" เรียบร้อย`);
      } catch(err){
        Swal.fire({icon:'error',title:'เกิดข้อผิดพลาด',text:String(err.message||err)});
      }
    }

    async function loadFolders() {
      try {
        const resp = await apiGet('getFolders');
        if (!resp.success) throw new Error(resp.message||'ไม่สามารถดึงโฟลเดอร์ได้');
        folders = Array.isArray(resp.data) ? resp.data : [];
        displayFolders();
        updateStatsFromFolders();
      } catch (e) {
        console.error(e);
      }
    }

    function displayFolders() {
      const container = document.getElementById('folderListContent');
      if (!folders || folders.length===0) {
        container.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <i class="fas fa-folder-open text-4xl mb-4"></i>
            <p>ยังไม่มีโฟลเดอร์</p>
            <p class="text-sm">สร้างโฟลเดอร์ใหม่เพื่อเริ่มต้นใช้งาน</p>
          </div>`;
        return;
      }
      container.innerHTML = folders.map(folder => `
        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="selectFolder('${folder.id}')">
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
              <i class="fas fa-folder text-blue-600 text-xl"></i>
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">${escapeHtml(folder.name)}</h4>
              <p class="text-sm text-gray-600">${(folder.fileCount||0)} ไฟล์ • ${formatDate(folder.createdDate)}</p>
            </div>
          </div>
          <div class="text-gray-400">
            <i class="fas fa-chevron-right"></i>
          </div>
        </div>
      `).join('');
    }

    function selectFolder(folderId) {
      const folder = folders.find(f=>f.id===folderId);
      if (folder) { hideFolderList(); showUploadModal(folder); }
    }

    // ====== UPLOADS ======
    function handleFileSelection(files) {
      if (!currentFolder) {
        Swal.fire({icon:'info',title:'กรุณาเลือกโฟลเดอร์ก่อน',text:'กด “อัพโหลดภาพ” เพื่อเลือกโฟลเดอร์'}); 
        return;
      }
      if (!files || files.length===0) return;

      // filter allowed + size
      const clean = [];
      for (const file of files) {
        if (!CLIENT_ALLOWED_TYPES.includes(file.type)) {
          addRecentActivity('ไฟล์ไม่ได้รับอนุญาต', `${file.name} (${file.type})`);
          continue;
        }
        if (file.size > MAX_FILE_SIZE) {
          addRecentActivity('ไฟล์ใหญ่เกินไป', `${file.name} (${formatFileSize(file.size)})`);
          continue;
        }
        clean.push({
          id: Date.now().toString() + Math.random().toString(36).slice(2),
          file,
          name: file.name,
          size: file.size,
          type: file.type,
          status: 'pending',
          progress: 0
        });
      }
      if (clean.length === 0) {
        Swal.fire({icon:'warning',title:'ไม่พบไฟล์ที่อัปโหลดได้',text:'ตรวจสอบชนิดไฟล์/ขนาดไฟล์อีกครั้ง'}); 
        return;
      }

      uploadQueue = clean;
      displayUploadQueue();
      document.getElementById('uploadQueue').classList.remove('hidden');
    }

    function displayUploadQueue() {
      const container = document.getElementById('uploadList');
      const total = uploadQueue.length;
      document.getElementById('uploadTotal').textContent = total;
      document.getElementById('uploadProgress').textContent =
        uploadQueue.filter(i=>i.status==='completed').length;

      container.innerHTML = uploadQueue.map(item => `
        <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
          <div class="flex items-center space-x-4 flex-1">
            <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
              <i class="fas ${getFileIcon(item.type)} text-gray-600"></i>
            </div>
            <div class="flex-1 min-w-0">
              <h5 class="font-medium text-gray-800 truncate">${escapeHtml(item.name)}</h5>
              <p class="text-sm text-gray-600">${formatFileSize(item.size)}</p>
              ${item.status === 'uploading' ? `
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                  <div class="bg-blue-600 h-2 rounded-full progress-bar" style="width:${item.progress}%"></div>
                </div>` : ''}
            </div>
          </div>
          <div class="ml-4">${getStatusIcon(item.status)}</div>
        </div>
      `).join('');

      // NEW: toggle header controls visibility
      const headerCtrls = document.getElementById('uploadHeaderControls');
      if (headerCtrls) {
        if (total > 0) headerCtrls.classList.remove('hidden');
        else headerCtrls.classList.add('hidden');
      }

      updateUploadingCount();
    }

    function updateUploadingCount() {
      const uploadingFiles = uploadQueue.filter(i=>i.status==='uploading').length;
      document.getElementById('uploadingFiles').textContent = uploadingFiles;
    }

    async function startUpload() {
      if (isUploading || uploadQueue.length===0 || !currentFolder) return;
      isUploading = true;
      const btn = document.getElementById('startUploadBtn');
      btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังอัพโหลด...';

      let success = 0, fail = 0;
      for (const item of uploadQueue) {
        if (item.status === 'pending' || item.status === 'failed') {
          const ok = await uploadOne(item);
          ok ? success++ : fail++;
        }
      }
      isUploading = false;
      btn.disabled = false; btn.innerHTML = '<i class="fas fa-check mr-2"></i>อัพโหลดเสร็จสิ้น';

      await loadFolders();
      await loadStats();

      if (fail === 0) {
        Swal.fire({icon:'success', title:'อัพโหลดสำเร็จ', text:`อัพโหลดไฟล์ทั้งหมด ${success} ไฟล์เรียบร้อยแล้ว`});
        uploadQueue = [];
        hideUploadModal();
      } else {
        Swal.fire({icon:'warning', title:'อัพโหลดเสร็จสิ้น', text:`สำเร็จ ${success} ไฟล์, ล้มเหลว ${fail} ไฟล์`});
      }
    }

    async function uploadOne(item) {
      try {
        item.status='uploading'; item.progress=0; displayUploadQueue();

        const base64 = await fileToBase64(item.file);
        for (let p=10;p<=90;p+=20){ item.progress=p; displayUploadQueue(); await sleep(120); }

        const resp = await apiPost({
          action:'uploadFile',
          folderId: currentFolder.id,
          fileName: item.name,
          fileType: item.type,
          fileSize: item.size,
          fileData: base64
        });
        if (!resp.success) throw new Error(resp.message||'อัปโหลดไม่สำเร็จ');

        item.progress=100; item.status='completed'; displayUploadQueue();
        addRecentActivity('อัพโหลดไฟล์', `✅ ${item.name}`);
        return true;
      } catch(e){
        console.error(e);
        item.status='failed'; displayUploadQueue();
        addRecentActivity('อัพโหลดล้มเหลว', `❌ ${item.name}`);
        return false;
      }
    }

    // ====== STATS ======
    function updateStatsFromFolders() {
      const totalFolders = folders.length;
      const totalFiles = folders.reduce((sum,f)=> sum + (Number(f.fileCount)||0), 0);
      document.getElementById('totalFolders').textContent = totalFolders;
      document.getElementById('totalFiles').textContent = totalFiles;
      document.getElementById('totalImages').textContent = Math.floor(totalFiles * 0.7);
      document.getElementById('totalVideos').textContent = Math.max(0, totalFiles - Math.floor(totalFiles * 0.7));
    }

    async function loadStats() {
      try {
        const resp = await apiGet('getStats');
        if (!resp.success || !resp.data) return;
        const s = resp.data;
        document.getElementById('totalFolders').textContent = s.totalFolders ?? '0';
        document.getElementById('totalFiles').textContent = s.totalFiles ?? '0';
        document.getElementById('totalImages').textContent = s.totalImages ?? '0';
        document.getElementById('totalVideos').textContent = s.totalVideos ?? '0';
      } catch(e){ console.warn('getStats failed', e); }
    }

    // ====== Helpers ======
    function addRecentActivity(action, description) {
      const container = document.getElementById('recentActivity');
      const item = document.createElement('div');
      item.className = 'flex items-center space-x-4 p-3 bg-gray-50 rounded-lg';

      const iconClass = action.includes('โฟลเดอร์') ? 'fa-folder-plus text-green-600'
                        : action.includes('อัพโหลด') ? 'fa-upload text-blue-600'
                        : 'fa-info text-gray-600';

      item.innerHTML = `
        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-sm">
          <i class="fas ${iconClass}"></i>
        </div>
        <div class="flex-1">
          <p class="text-gray-800 font-medium">${escapeHtml(action)}</p>
          <p class="text-sm text-gray-600">${escapeHtml(description)}</p>
          <p class="text-xs text-gray-500">${new Date().toLocaleString('th-TH')}</p>
        </div>`;
      const firstInfo = container.querySelector('.fas.fa-info');
      if (firstInfo) firstInfo.closest('.flex').remove();
      container.prepend(item);
      while (container.children.length > 5) container.removeChild(container.lastChild);
    }

    function getFileIcon(type){ if(type.startsWith('image/')) return 'fa-image'; if(type.startsWith('video/')) return 'fa-video'; return 'fa-file'; }
    function getStatusIcon(status){
      switch(status){
        case 'pending': return '<i class="fas fa-clock text-gray-400"></i>';
        case 'uploading': return '<i class="fas fa-spinner fa-spin text-blue-600"></i>';
        case 'completed': return '<i class="fas fa-check-circle text-green-600"></i>';
        case 'failed': return '<i class="fas fa-exclamation-circle text-red-600"></i>';
        default: return '';
      }
    }
    function formatFileSize(bytes){ if(bytes===0) return '0 Bytes'; const k=1024, sizes=['Bytes','KB','MB','GB']; const i=Math.floor(Math.log(bytes)/Math.log(k)); return (bytes/Math.pow(k,i)).toFixed(2)+' '+sizes[i]; }
    function formatDate(dt){ if(!dt) return '-'; const d=new Date(dt); return d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'}); }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const res = reader.result || '';
          const base64 = res.includes(',') ? res.split(',')[1] : res;
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
